<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Steven Delean &amp; Stevie Pederson">

<title>Transcriptomics Practical</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="visualisation_and_rmarkdown_files/libs/clipboard/clipboard.min.js"></script>
<script src="visualisation_and_rmarkdown_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="visualisation_and_rmarkdown_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="visualisation_and_rmarkdown_files/libs/quarto-html/popper.min.js"></script>
<script src="visualisation_and_rmarkdown_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="visualisation_and_rmarkdown_files/libs/quarto-html/anchor.min.js"></script>
<link href="visualisation_and_rmarkdown_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="visualisation_and_rmarkdown_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="visualisation_and_rmarkdown_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="visualisation_and_rmarkdown_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="visualisation_and_rmarkdown_files/libs/bootstrap/bootstrap-1e1b6d7d3018d0281420745e134191b0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#last-session" id="toc-last-session" class="nav-link" data-scroll-target="#last-session">Last Session</a></li>
  <li><a href="#todays-content" id="toc-todays-content" class="nav-link" data-scroll-target="#todays-content">Today’s Content</a></li>
  </ul></li>
  <li><a href="#data-visualisation" id="toc-data-visualisation" class="nav-link" data-scroll-target="#data-visualisation">Data Visualisation</a>
  <ul class="collapse">
  <li><a href="#data-import" id="toc-data-import" class="nav-link" data-scroll-target="#data-import">Data Import</a></li>
  <li><a href="#base-graphics-in-r" id="toc-base-graphics-in-r" class="nav-link" data-scroll-target="#base-graphics-in-r">Base Graphics in R</a>
  <ul class="collapse">
  <li><a href="#simple-x-vs-y-plots" id="toc-simple-x-vs-y-plots" class="nav-link" data-scroll-target="#simple-x-vs-y-plots">Simple x vs y plots</a></li>
  <li><a href="#boxplots" id="toc-boxplots" class="nav-link" data-scroll-target="#boxplots">Boxplots</a></li>
  <li><a href="#histograms" id="toc-histograms" class="nav-link" data-scroll-target="#histograms">Histograms</a></li>
  </ul></li>
  <li><a href="#using-ggplot2" id="toc-using-ggplot2" class="nav-link" data-scroll-target="#using-ggplot2">Using <code>ggplot2</code></a>
  <ul class="collapse">
  <li><a href="#layers" id="toc-layers" class="nav-link" data-scroll-target="#layers">Layers</a></li>
  <li><a href="#initialising-a-plot" id="toc-initialising-a-plot" class="nav-link" data-scroll-target="#initialising-a-plot">Initialising a Plot</a></li>
  <li><a href="#adding-aesthetics" id="toc-adding-aesthetics" class="nav-link" data-scroll-target="#adding-aesthetics">Adding Aesthetics</a></li>
  <li><a href="#adding-geometry" id="toc-adding-geometry" class="nav-link" data-scroll-target="#adding-geometry">Adding Geometry</a></li>
  <li><a href="#adding-statistics" id="toc-adding-statistics" class="nav-link" data-scroll-target="#adding-statistics">Adding statistics</a></li>
  <li><a href="#changing-the-theme" id="toc-changing-the-theme" class="nav-link" data-scroll-target="#changing-the-theme">Changing the Theme</a></li>
  <li><a href="#adding-coordinates-scales" id="toc-adding-coordinates-scales" class="nav-link" data-scroll-target="#adding-coordinates-scales">Adding Coordinates (Scales)</a></li>
  <li><a href="#creating-a-boxplot" id="toc-creating-a-boxplot" class="nav-link" data-scroll-target="#creating-a-boxplot">Creating a Boxplot</a></li>
  </ul></li>
  <li><a href="#modifying-categories-with-forcats" id="toc-modifying-categories-with-forcats" class="nav-link" data-scroll-target="#modifying-categories-with-forcats">Modifying Categories With <code>forcats</code></a>
  <ul class="collapse">
  <li><a href="#more-creative-geometry" id="toc-more-creative-geometry" class="nav-link" data-scroll-target="#more-creative-geometry">More Creative Geometry</a></li>
  <li><a href="#histograms-1" id="toc-histograms-1" class="nav-link" data-scroll-target="#histograms-1">Histograms</a></li>
  <li><a href="#bar-plots" id="toc-bar-plots" class="nav-link" data-scroll-target="#bar-plots">Bar Plots</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#rmarkdown" id="toc-rmarkdown" class="nav-link" data-scroll-target="#rmarkdown">RMarkdown</a>
  <ul class="collapse">
  <li><a href="#a-brief-introduction" id="toc-a-brief-introduction" class="nav-link" data-scroll-target="#a-brief-introduction">A Brief Introduction</a></li>
  <li><a href="#markdown" id="toc-markdown" class="nav-link" data-scroll-target="#markdown">Markdown</a></li>
  <li><a href="#rmarkdown-1" id="toc-rmarkdown-1" class="nav-link" data-scroll-target="#rmarkdown-1">RMarkdown</a>
  <ul class="collapse">
  <li><a href="#a-brief-introduction-1" id="toc-a-brief-introduction-1" class="nav-link" data-scroll-target="#a-brief-introduction-1">A Brief Introduction</a></li>
  <li><a href="#the-structure-of-an-rmarkdown-file" id="toc-the-structure-of-an-rmarkdown-file" class="nav-link" data-scroll-target="#the-structure-of-an-rmarkdown-file">The Structure of an RMarkdown File</a></li>
  <li><a href="#making-our-own-report" id="toc-making-our-own-report" class="nav-link" data-scroll-target="#making-our-own-report">Making Our Own Report</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Transcriptomics Practical</h1>
<p class="subtitle lead">Practical 3: Data Visualisation</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Steven Delean &amp; Stevie Pederson </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Adelaide University &amp; Black Ochre Data Labs
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="last-session" class="level2">
<h2 class="anchored" data-anchor-id="last-session">Last Session</h2>
<p>In the previous practical we introduced several key packages from the <code>tidyverse</code> which are fundamental data science packages, heavily used in bioinformatics. These included:</p>
<ol type="1">
<li>Using the <code>magrittr</code> to chain together multiple functions</li>
<li>How to perform Excel-like operations on a data frame
<ul>
<li>Including sorting and filtering</li>
<li>Subsetting rows and columns</li>
<li>Modifying existing columns and adding new columns</li>
<li>Pivoting data into longer or wider format</li>
</ul></li>
</ol>
</section>
<section id="todays-content" class="level2">
<h2 class="anchored" data-anchor-id="todays-content">Today’s Content</h2>
<p>Now that we know the basics of data exploration, we can start visualising transcriptomics data using <code>ggplot2</code>. Just like the previous packages, <code>ggplot2</code> is actually a core package from an ecosystem known as the <code>tidyverse</code>.</p>
<p><img src="assets/tidy_workflow.png" class="img-fluid"></p>
<p>During the course of the practical we’ll also briefly encounter both <code>stringr</code> for working with character vectors (or columns) and <code>forcats</code> for working with categorical variables, known as <code>factors</code> in R.</p>
<p>Once we’ve walked through the fundamentals of data visualisation, we’ll move to a way of managing your code alongside formatted notes, beautifully presented tables and high-quality figures, using <code>rmarkdown</code>.</p>
</section>
</section>
<section id="data-visualisation" class="level1">
<h1>Data Visualisation</h1>
<section id="data-import" class="level2">
<h2 class="anchored" data-anchor-id="data-import">Data Import</h2>
<p>Before starting any visualisation, let’s start a new R script called <code>data_visualisation.R</code> and begin our script with the following</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/psen2VsWT.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.1     ✔ stringr   1.6.0
✔ ggplot2   4.0.0     ✔ tibble    3.3.0
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.2.0     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors
Rows: 16021 Columns: 15
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (6): gene_id, gene_name, chromosome, gene_biotype, description, entrezid
dbl (9): logFC, logCPM, PValue, FDR, start, end, gc_content, length, LR

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>As we now know, calling <code>library(tidyverse)</code> will load several packages, including <code>ggplot2</code>, along with those from the last session.</p>
</section>
<section id="base-graphics-in-r" class="level2">
<h2 class="anchored" data-anchor-id="base-graphics-in-r">Base Graphics in R</h2>
<p>As might be expected, R comes with quite powerful graphics capability built in, via the package <code>graphics</code>, installed with every R installation. These methods were the workhorse for the first 10-15 years of R usage and still have their place, however <code>ggplot2</code> has become the industry standard across most of science. Let’s take a minute to explore the basics before moving on the <code>ggplot2</code>. The main plotting functions we’ll look at are:</p>
<ol type="1">
<li>Points, usually in x vs y format</li>
<li>Boxplots, looking at the ranges of data within categories</li>
<li>Histograms, looking at the distribution of a large number of data points</li>
</ol>
<section id="simple-x-vs-y-plots" class="level3">
<h3 class="anchored" data-anchor-id="simple-x-vs-y-plots">Simple x vs y plots</h3>
<p>Comparing to values (x &amp; y) from a dataset is one of the most common figure types. Now we understand that columns are just vectors, we could show two columns from <code>psen2VsWT</code> against each other very easily. If we compare logFC against logCPM, we’ll be plotting the change after treatment against the average expression, known colloquially in transcriptomics as an MA plots (despite neither value being M or A).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(psen2VsWT<span class="sc">$</span>logCPM, psen2VsWT<span class="sc">$</span>logFC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The default points look a bit rubbish, so we can change them to a solid circle by adding <code>pch = 19</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(psen2VsWT<span class="sc">$</span>logCPM, psen2VsWT<span class="sc">$</span>logFC, <span class="at">pch =</span> <span class="dv">19</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This may not be intuitive at all, but jump to the help page for points using <code>?pch</code>. A few lines below the <strong>Details</strong> header you’ll see that <code>pch</code> is short for “plotting character’, and further down the page is a figure that shows what character gets shown for each value.</p>
<ul>
<li>0-14 are empty shapes, with some being an overlay of two different ones (e.g.&nbsp;13)</li>
<li>15-20 are filled shapes</li>
<li>21-25 are shapes with an outline colour and a filled colour</li>
</ul>
<p>In addition to changing the points, we can add lines to the plot after it’s been created. The following adds a horizontal (<code>h</code>) line at <span class="math inline">\(y=0\)</span>, choosing the line-type (<code>lty</code>) to be <code>"dashed"</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also add titles using the function <code>title()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">"A Simple MA Plot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="boxplots" class="level3">
<h3 class="anchored" data-anchor-id="boxplots">Boxplots</h3>
<p>Sometimes we wish to look at the distribution of values within categories. We haven’t formally looked at categorical data yet, but as you can see there are some columns in <code>psen2VsWT</code> which are clearly categories, such as <code>chromosome</code> and <code>gene_biotype</code> When using boxplots the value we wish to view will be on the y-axis, with the categories on the x-axis, and we can specify this using R’s formula syntax: <code>y ~ x</code>. We read this as <code>y</code> <em>depends on</em> <code>x</code>, or <code>y</code> <em>is a function of</em> <code>x</code>.</p>
<p>We’ll look at <code>gc_content</code> by <code>gene_biotype</code>, so will use the formula <code>gc_content ~ gene_biotype</code>. Notice that because we’re using a formula, we need to tell R which data object the two columns are in, and we pass this to the function as <code>data = psen2V2WT</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(gc_content <span class="sc">~</span> gene_biotype, <span class="at">data =</span> psen2VsWT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are a lot of categories here and some might not display well on the x-axis, but we’ll learn how to work around that a bit later. In general, this is a nice, quick &amp; easy way to have first look at values we’re interested in.</p>
</section>
<section id="histograms" class="level3">
<h3 class="anchored" data-anchor-id="histograms">Histograms</h3>
<p>Sometimes, we wish to inspect histograms, and this is a very common visualisation for <span class="math inline">\(p\)</span>-values. We know from our basic statistics lectures that for every data point where <span class="math inline">\(H_0\)</span> is true, these values will be drawn from an Uniform distribution between 0 &amp; 1, i.e.&nbsp;<span class="math inline">\(\mathcal{U}(0, 1)\)</span>. This means they should be randomly distributed between the limits of the distribution, i.e 0 &amp; 1.</p>
<p>Under <span class="math inline">\(H_A\)</span> however, the p-values will be very small. In transcriptomics, we commonly see the majority of genes being unaffected by the treatment, but a small number being impacted, so we should see a cluster of small p-values in amongst a random distribution between 0 &amp; 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(psen2VsWT<span class="sc">$</span>PValue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just as we expected!</p>
</section>
</section>
<section id="using-ggplot2" class="level2">
<h2 class="anchored" data-anchor-id="using-ggplot2">Using <code>ggplot2</code></h2>
<div class="columns">
<div class="column" style="width:75%;">
<p>Now we’ve seen the key basic graphics capability, let’s move straight to <code>ggplot2</code>, which makes the creation of complex and highly-detailed figures comparatively simple.</p>
</div><div class="column" style="width:25%;">
<p><img src="https://ggplot2.tidyverse.org/logo.png" class="img-fluid"></p>
</div>
</div>
<section id="layers" class="level3">
<h3 class="anchored" data-anchor-id="layers">Layers</h3>
<p><code>ggplot2</code> is an R implementation of <a href="https://link.springer.com/book/10.1007/0-387-28695-0">The Grammar of Graphics</a> (hence the <code>gg</code>), by Hadley Wickham <span class="citation" data-cites="Wickham2016-gg">Wickham (<a href="#ref-Wickham2016-gg" role="doc-biblioref">2016</a>)</span>. The foundational principles are that we build a plot in layers, similar to how we added lines and a title above, but in a clearly structured way. The basic types of layers are:</p>
<p><img src="assets/gglayers.png" class="img-fluid"></p>
<p>In more clear language, this means we:</p>
<ol type="1">
<li>Organise our data</li>
<li>Defining key variables (i.e.&nbsp;columns) my mapping them to “aesthetics”, where aesthetics are colour, shape, linetype, transparency etc</li>
<li>Decide which type of geometry we’ll use, e.g.&nbsp;lines, points, boxplots etc</li>
</ol>
<p>From there we have optional layers:</p>
<ol start="4" type="1">
<li>Facets represent sub-panels within each plot</li>
<li>Statistics are the summary type values to add, such as regression lines, ellipses etc</li>
<li>Co-ordinates represent the scales, such as the x &amp; y axes and whether we log transform, the different colour palettes etc</li>
<li>The <code>theme</code> is the overall style of the plot
<ul>
<li>Where do we place the legend</li>
<li>What font size should our axis labels be</li>
<li>The background colour scheme</li>
</ul></li>
</ol>
<p>Usually, we deal with the first three as our key focus, then modify the scales &amp; themes as needed</p>
</section>
<section id="initialising-a-plot" class="level3">
<h3 class="anchored" data-anchor-id="initialising-a-plot">Initialising a Plot</h3>
<p>To start with, we’ll need to call the function <code>ggplot()</code></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>package</strong> is called <code>ggplot2</code> because it was Hadley’s second attempt as he developed the package during his PhD thesis.</p>
<p>The <strong>function</strong> we call is <code>ggplot()</code>.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(psen2VsWT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is the very first step, corresponding to the “data” layer. It’s an empty plotting panel because we haven’t mapped any columns to plotting aesthetics.</p>
</section>
<section id="adding-aesthetics" class="level3">
<h3 class="anchored" data-anchor-id="adding-aesthetics">Adding Aesthetics</h3>
<p>Now we’ve initialised the plot, we can add aesthetics. Let’s recreate that MA-plot from earlier, so we’ll map <code>logCPM</code> to the x-axis and <code>logFC</code> to the y-axis</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(psen2VsWT) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> logCPM, <span class="at">y =</span> logFC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice that we’ve added the mappings by placing a <code>+</code> after the initial call to <code>ggplot()</code>. This effectively tells R <em>there is more to come</em>, and we use this to <em>add layers</em>, which hopefully feels relatively intuitive. It’s subtly different to the pipe (or magrittr) because it doesn’t really pass the data to the next function or place it in the first argument, although it does refer back to the original data still.</p>
<p>To be honest, Hadley wrote <code>ggplot2</code> before the R base pipe or <code>magrittr</code> had been developed, so using the <code>+</code> was the best he had to work with. He did try a rewrite called <code>ggvis</code> which used the magrittr instead of the <code>+</code> symbol, but he abandoned it.</p>
</div>
</div>
<p>Now you’ll see the (still empty) plot, but the range of the columns we’ve assigned to the x &amp; y axes will be visible as the axis limits. Once we assign the geometry, the points will be drawn</p>
</section>
<section id="adding-geometry" class="level3">
<h3 class="anchored" data-anchor-id="adding-geometry">Adding Geometry</h3>
<p>To draw the points, we simply add <code>geom_point</code> (which uses <code>pch = 19</code> as the default, which is much nicer)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(psen2VsWT) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> logCPM, <span class="at">y =</span> logFC) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And that’s the basics covered! Let’s add some more layers.</p>
</section>
<section id="adding-statistics" class="level3">
<h3 class="anchored" data-anchor-id="adding-statistics">Adding statistics</h3>
<p>There’s no real need for sub-panels (or facets) so let’s add a regression line using <code>stat_smooth()</code>. Unless we specify the method, <code>stat_smooth()</code> will automatically decide what statistical model should be applied. We know we want a linear regression line, so we can specify <code>method = "lm"</code> which will call the R function <code>lm()</code> which applies a linear model (or a linear regression model).</p>
<p>By default, the standard errors of the regression would be shown, so we turn them off using <code>se = FALSE</code>.</p>
<p>Finally, we decided we wanted a blue line so we chose <code>colour = "blue"</code>. Conveniently for Australians, Hadley Wickham is from New Zealand so he doesn’t use American spelling for words like “colour”, although it is recognised as an argument name if you really must use US spelling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(psen2VsWT) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> logCPM, <span class="at">y =</span> logFC) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Try changing the colour to something else</strong> noting that any colour name must be quoted. There are 657 named colours recognised by R, so if you stick to the obvious colours, you’ll likely be OK.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Regression lines like this are commonly used in MA plots to easily detect the presence of any systemic bias in transcriptomics data. A regression line through this type of data should be very, very close to the line <span class="math inline">\(y=0\)</span> and this line appears pretty close. There’s always a little variation, but this dataset looks OK!</p>
<p>Sometimes we fit a curve through the data, so if you’re curious remove <code>method = "lm"</code> from the call to <code>stat_smooth</code> and a curve will be fitted by default. This too looks pretty close to the line <span class="math inline">\(y=0\)</span> even though it’s actually a curve</p>
</div>
</div>
</section>
<section id="changing-the-theme" class="level3">
<h3 class="anchored" data-anchor-id="changing-the-theme">Changing the Theme</h3>
<p>If you’re like many researchers, you’ll a little unhappy with that grey background. This is the default theme for <code>ggplot2</code> and as actually provided as a default theme called <code>theme_grey()</code>. We’ll dig into themes later, but for now, let’s apply a different theme, known as <code>theme_bw()</code> which is a common alternative default theme</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(psen2VsWT) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> logCPM, <span class="at">y =</span> logFC) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because <code>theme_gery()</code> isn’t a popular theme, we can actually set the default theme by adding the following line of code to change the default.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This resets the default theme to be <code>theme_bw()</code> for every plot, saving us a little effort</p>
</section>
<section id="adding-coordinates-scales" class="level3">
<h3 class="anchored" data-anchor-id="adding-coordinates-scales">Adding Coordinates (Scales)</h3>
<p>So far we have only mapped logCPM to the x-axis and logFC to the y-axis, but we can also apply other aesthetics, such as colour. For this, we’ll switch to piping the data into the initial call to <code>ggplot()</code> and will modify the data on the way in, just like we saw in the last session.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DE =</span> FDR <span class="sc">&lt;</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> logCPM, <span class="at">y =</span> logFC, <span class="at">colour =</span> DE) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span> <span class="st">"blue"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We didn’t need to apply <code>theme_bw()</code> any more, which saved one line of code, but notice that <code>ggplot</code> has now mapped the <code>TRUE</code> and <code>FALSE</code> values to two different colours. Hopefully, you can now see why we spent so much time on the <code>magrittr</code> last session as we can do these “on the fly” operations without needing to modify the original data.</p>
<p>The default <code>ggplot2</code> colour scheme is also a bit of a cliche at this point, so let’s map each value to a co-ordinate using a scale function. We’ll use the scale function <code>scale_colour_manual()</code> which allows us to specify colour exactly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DE =</span> FDR <span class="sc">&lt;</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> logCPM, <span class="at">y =</span> logFC, <span class="at">colour =</span> DE) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are multiple options for setting the colour palette with some great options provided by <code>scale_colour_brewer()</code> where we can choose from the palettes visible using <code>RColorBrewer::display.brewer.all()</code>. These are discrete colour palettes, whilst some continuous color palettes are provided by <code>scale_colour_viridis_c()</code>, or a number of other functions.</p>
</div>
</div>
<p><strong>Try changing <code>scale_colour_manual()</code> to <code>scale_colour_brewer(palette = "Set1")</code></strong></p>
</section>
<section id="creating-a-boxplot" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-boxplot">Creating a Boxplot</h3>
<p>Now we’ve really explored plotting points, let’s try a boxplot. We can start with the same one we tried earlier, where we show GC content as a function of gene biotype. Because of the way we map columns to aesthetics, we don’t need the R formula syntax any more</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> gene_biotype, <span class="at">y =</span> gc_content) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This time all of the x-axis labels are shown, but they overlap &amp; look terrible. We can use <code>theme()</code> to rotate these.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> gene_biotype, <span class="at">y =</span> gc_content) <span class="sc">+</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That takes a little explaining, but most of our graphical parameters we can modify using a theme fall into three categories, where attributes are set using an <code>element_*()</code> function</p>
<ol type="1">
<li>text: <code>element_text()</code></li>
<li>line: <code>element_line()</code></li>
<li>rectangles (or boxes): <code>element_rect()</code></li>
</ol>
<p>In these we can set font size, line width and many other attributes for the specific theme element we wish to modify. In the above we wanted to rotate the x-axis labels, which are modified using <code>axis.text.x = element_text()</code>. We also added <code>hjust = 1</code> which sets the horizontal-adjustment of the text to be right aligned. This places the label hard up against the axis. The final argument was <code>vjust = 0.5</code> which sets the vertical adjustment of the labels to be centre aligned. Sometimes the defaults don’t quite look how we’d hoped so we need to add these. An Adelaide-based R developer (Jonathan Carroll) has also written a package called <a href="https://cran.r-project.org/web/packages/ggeasy/index.html"><code>ggeasy</code></a> which tries to simplify some of these operations.</p>
<p>Themes are very powerful, but can be a little overwhelming. Check the help page <code>?theme</code> to see the extent of the options we can use. It’s truly all-encompassing</p>
<p>An alternative strategy for making those gene biotypes readable might be to switch the x &amp; y axes, which is very easy to do using <code>ggplot2</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> gc_content, <span class="at">y =</span> gene_biotype) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="modifying-categories-with-forcats" class="level2">
<h2 class="anchored" data-anchor-id="modifying-categories-with-forcats">Modifying Categories With <code>forcats</code></h2>
<p>The above boxplot has shown the gene biotypes in alpha-numeric order, with <code>antisense</code> at the bottom then moving in order to <code>unprocessed_pseudogene</code> at the top. R has silently coerced the <code>gene_biotype</code> column into a categorical variable (i.e.&nbsp;a <code>factor</code>) when we mapped a character column to an axis. In reality, this is what we’d want nearly every time, so this is a helpful decision.</p>
<p>However, we might like to change the order of these along the axis, and if we <em>manually set the order of the categories</em>, we can gain much greater control over the ordering of the boxes. First, let’s stick with the default function, <code>as.factor()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_biotype =</span> <span class="fu">as.factor</span>(gene_biotype))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that under the column name, this column is now showing <code>&lt;fct&gt;</code>, telling us that this is now a factor, which is a categorical variable in R. The default function will have used alpha-numeric order just like we’ve seen in the plot. The summary table below will be ordered using the category order (or “factor levels”)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_biotype =</span> <span class="fu">as.factor</span>(gene_biotype)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gene_biotype)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A sensible alternative might be to place the order of categories in order of how common they are. We can use <code>fct_infreq()</code> for this, which orders the categories by how many times they’re seen.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_biotype =</span> <span class="fu">fct_infreq</span>(gene_biotype)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gene_biotype)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now if we plot these, <code>protein_coding</code> will be first on the y-axis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_biotype =</span> <span class="fu">fct_infreq</span>(gene_biotype)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> gc_content, <span class="at">y =</span> gene_biotype) <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can reverse this using <code>fct_rev()</code> either inside the mutate, or in the aesthetic mappings. Let’s try it using the mappings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gene_biotype =</span> <span class="fu">fct_infreq</span>(gene_biotype)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> gc_content, <span class="at">y =</span> <span class="fu">fct_rev</span>(gene_biotype)) <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(Notice the y-axis label changed according to this change)</p>
<p>If we recall those summary tables we just created, there are a few biotypes with only one or two genes. Wouldn’t it be nice to collapse these into a merged or “Other” category? We can do this using one of the <code>fct_lump_*()</code> functions, where</p>
<ul>
<li><code>fct_lump_min()</code> sets a minimum number of observations to be in a group before lumping them into the “Other” category</li>
<li><code>fct_lump_prop()</code> sets a minimum proportion of observations before being lumped into “Other”</li>
<li><code>fct_lump_n()</code> sets a minimum number of groups</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_biotype =</span> gene_biotype <span class="sc">%&gt;%</span> <span class="fu">fct_infreq</span>() <span class="sc">%&gt;%</span> <span class="fu">fct_lump_min</span>(<span class="at">min =</span> <span class="dv">5</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gene_biotype)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The above use of the magrittr <strong>inside a function</strong> is new, but commonly used. It allows us to perform multiple modifications to a column very easily</p>
</div>
</div>
<p>As you can see from the table, the smallest group size is now 5 and all of the other biotypes have been merged into “Other” Let’s see how that changes the plot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_biotype =</span> gene_biotype <span class="sc">%&gt;%</span> <span class="fu">fct_infreq</span>() <span class="sc">%&gt;%</span> <span class="fu">fct_lump_min</span>(<span class="at">min =</span> <span class="dv">5</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> gc_content, <span class="at">y =</span> <span class="fu">fct_rev</span>(gene_biotype)) <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s much less overwhelming!</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Factors">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Factors
</div>
</div>
<div class="callout-body-container callout-body">
<p>Manipulating categorical data using factors is an extremely common operation. By default, the alpha-numeric ordering of the chromosomes would be chr1, chr10, chr11 etc and we’d need to think carefully about how to reorder those. We can manually set the levels using <code>factor()</code> instead of <code>as.factor()</code>, and passing a character vector of levels using a trick like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>levels <span class="ot">&lt;-</span>  <span class="fu">paste0</span>(<span class="st">"chr"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>, <span class="st">"M"</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>levels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We haven’t spent any time really working character vectors yet, but that will happen soon enough</p>
</div>
</div>
<section id="more-creative-geometry" class="level3">
<h3 class="anchored" data-anchor-id="more-creative-geometry">More Creative Geometry</h3>
<p>So far we’ve only seen boxplot and simple points, but there are many more options in ggplot such as:</p>
<ul>
<li>Lines: <code>geom_line()</code>, <code>geom_abline()</code>, <code>geom_hline()</code>, <code>geom_vline()</code></li>
<li>Distributions: <code>geom_boxplot()</code>, <code>geom_violin()</code></li>
<li>Histograms: <code>geom_histogram()</code>, <code>geom_density()</code></li>
<li>Bar Plots: <code>geom_bar()</code>, <code>geom_col()</code> + <code>geom_errorbar()</code></li>
<li>Heatmaps: <code>geom_tile()</code>, <code>geom_raster()</code>, <code>geom_rect()</code></li>
</ul>
<p>Your data and the story your data tells will determine which type of plot you produce, and we won’t have time to look at all of those, but let’s browse a few just for fun.</p>
<section id="violin-plots" class="level4">
<h4 class="anchored" data-anchor-id="violin-plots">Violin Plots</h4>
<p><code>geom_violin()</code> is becoming a popular alternative to boxplot as you see the true shape of the distribution a little more clearly. Let’s switch that straight in for <code>geom_boxplot()</code> and adding a different fill colour using the biotype. We could’ve also done this for <code>geom_boxplot()</code>. We’ve also used one of the fill palettes from <code>scale_fill_brewer()</code> which is what we use when providing the coordinates for a fill, whereas <code>scale_colour_brewer()</code> would’ve been what we used if mapping a colour (i.e.&nbsp;boxplot outline colour)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_biotype =</span> gene_biotype <span class="sc">%&gt;%</span> <span class="fu">fct_infreq</span>() <span class="sc">%&gt;%</span> <span class="fu">fct_lump_min</span>(<span class="at">min =</span> <span class="dv">5</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> gc_content, <span class="at">y =</span> <span class="fu">fct_rev</span>(gene_biotype), <span class="at">fill =</span> gene_biotype) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">quantiles =</span> <span class="fl">0.5</span>, <span class="at">quantile.linetype =</span> <span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Paired"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="histograms-1" class="level3">
<h3 class="anchored" data-anchor-id="histograms-1">Histograms</h3>
<p>The default histogram in <code>ggplot2</code> is a little ugly</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> PValue) <span class="sc">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we can set the bin-width easily and with some minor edits, this can look good really quickly</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> PValue) <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.01</span>, <span class="at">fill =</span> <span class="st">"grey70"</span>, <span class="at">colour =</span> <span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we didn’t set the y aesthetic as a histogram will automatically choose the count. We can set the frequency using <code>y = after_stat(density)</code> if we’d like though</p>
</section>
<section id="bar-plots" class="level3">
<h3 class="anchored" data-anchor-id="bar-plots">Bar Plots</h3>
<p>Barplots also make great summary figures and piping the data can be really powerful as well. By default, <code>geom_bar()</code> will count the observations and summarise for us.</p>
<p>In the following:</p>
<ul>
<li>We’ve also applied those chromosome factor levels from earlier in the session</li>
<li>The DE column has been made a categorical variable</li>
<li>The manual colours have been set using a named vector</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">DE =</span> <span class="fu">as.factor</span>(FDR <span class="sc">&lt;</span> <span class="fl">0.01</span>),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">chromosome =</span> <span class="fu">factor</span>(chromosome, <span class="at">levels =</span> levels)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(chromosome, <span class="at">fill =</span> <span class="fu">fct_rev</span>(DE))) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"red"</span>), <span class="at">name =</span> <span class="st">"DE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="rmarkdown" class="level1">
<h1>RMarkdown</h1>
<section id="a-brief-introduction" class="level2">
<h2 class="anchored" data-anchor-id="a-brief-introduction">A Brief Introduction</h2>
<p>Now that we’ve explored much of the <code>tidyverse</code>, we can move outside the <code>tidyverse</code> and look at using a file format called RMarkdown. This is the approach used by many bioinformaticians to manage extremely complex analyses, and allows us to to perform an analysis embedding nicely formatted text descriptions, tables and figures alongside our code, and where all results are actually generated by running the code as the document is compiled.</p>
<p>R Scripts are still very heavily used for many tasks, such as package development, writing custom functions and submitting jobs to High-Performance Compute Clusters (HPCs), but RMarkdown allows us to build our analysis interactively, describing what we see as we go, the compiling it all together as a PDF, MS Word document or even an HTML page.</p>
<p>The entire transcriptomics practical series (and the lectures) were written using the latest generation of RMarkdown called <code>quarto</code>. However, the strategy and format is near identical.</p>
</section>
<section id="markdown" class="level2">
<h2 class="anchored" data-anchor-id="markdown">Markdown</h2>
<p>Before we learn RMarkdown, we need to understand the simpler format “markdown” which is what RMarkdown extends. For those who are familiar with <a href="www.github.com">github</a>, most README files are written using this syntax, along with quite a bit of comprehensive documentation. For example, the Release Notes for most R packages on CRAN or Bioconductor are documented in a file called “NEWS.md”, with an example <a href="https://github.com/tidyverse/ggplot2/blob/main/NEWS.md">here</a>.</p>
<p>Let’s start by creating a new file</p>
<pre><code>1. File &gt; New File &gt; MarkdownFile
2. Save as README.md</code></pre>
<div class="callout callout-style-default callout-tip callout-titled" title="Markdown Formatting">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Markdown Formatting
</div>
</div>
<div class="callout-body-container callout-body">
<p>These are plain text files, however we can denote important formatting features using some pre-defined syntax. They’ll appear without formatting (beside the pretty things RStudio adds) but when we compile them, all of the formatting will be rendered as we expect:</p>
<ul>
<li><p>Section Headers are denoted by one or more <code>#</code> symbols</p>
<ul>
<li><code>#</code> is the highest level, <code>##</code> is next highest etc.</li>
</ul></li>
<li><p>Italic text is set by enclosing text between a single asterisk (<code>*</code>) or underscore (<code>_</code>)</p></li>
<li><p>Bold text is set by using <em>two asterisks</em> (<code>**</code>) or <em>two underscores</em> (<code>__</code>)</p></li>
<li><p>Dot-point Lists are started by prefixing each line with <code>-</code></p>
<ul>
<li>Next level indents are formed by adding 2 or 4 spaces before the next <code>-</code></li>
</ul></li>
<li><p>Numeric Lists are formed by starting a line with <code>1.</code></p>
<ul>
<li>Subsequent lines don’t need to be numbered in order</li>
</ul></li>
</ul>
</div>
</div>
<p>Let’s quickly edit our file so there’s something informative. On the top line enter</p>
<p><code># Transcriptomics Pratical Series</code></p>
<p>Two lines down add <code>## Course Outline</code></p>
<p>Leave another blank line then add</p>
<p><code>1. Introduction to R and R Studio</code><br>
<code>2. The Tidyverse</code><br>
<code>3. Data Visualisation</code><br>
<code>4. R Markdown</code></p>
<p><code>**All material**</code> can be found at [the course homepage](https://github.com/University-of-Adelaide-Bx-Masters/Bioinformatics_Sequencing_Technologies/)</p>
<p>Here we’ve set the first two words to appear in bold font. The section in the square brackets will appear as text with a hyperlink to the site in the round brackets</p>
<p>Now…</p>
<p>Click the <code>Preview Button</code> and an HTML document appears. Note that README.html has also been produced!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Sites like github/gitlab render this automatically, as does Obsidian</p>
</div>
</div>
<p>This really is the basics to Markdown. It’s simple &amp; elegant way to produce clean documents with minimal overheads (like opening MS Word). Although we haven’t seen it today, complex mathematical equations can also be described using Markdown.</p>
</section>
<section id="rmarkdown-1" class="level2">
<h2 class="anchored" data-anchor-id="rmarkdown-1">RMarkdown</h2>
<section id="a-brief-introduction-1" class="level3">
<h3 class="anchored" data-anchor-id="a-brief-introduction-1">A Brief Introduction</h3>
<p>RMarkdown extends Markdown to incorporate executed R code alongside the standard Markdown formatting. We can easily produce a document with section headers, tables and formatted text, alongside figures, results and the code used to produce them. This ensure that all figures and results are taken directly from the executed code, avoiding any copy-paste errors, or the use of old results before the new samples arrived etc</p>
<p>The file suffix for RMarkdown is .Rmd, and we can output our analysis directly as:</p>
<ul>
<li>HTML</li>
<li>MS Word Documents</li>
<li>PDF Documents (If you have <span class="math inline">\(\LaTeX\)</span> installed)</li>
<li>HTML or PowerPoint presentations</li>
</ul>
<p>We never need to use MS Word, Excel or PowerPoint again!</p>
</section>
<section id="the-structure-of-an-rmarkdown-file" class="level3">
<h3 class="anchored" data-anchor-id="the-structure-of-an-rmarkdown-file">The Structure of an RMarkdown File</h3>
<p>Let’s create our first <code>rmarkdown</code> document</p>
<ol type="1">
<li>Go to the <code>File</code> drop-down menu in RStudio</li>
<li>New File -&gt; R Markdown…</li>
</ol>
<p><img src="assets/NewRMarkdown.png" class="img-fluid"></p>
<ol type="1">
<li>Change the Title to: My First Report</li>
<li>Change the Author to however you’d like to refer to yourself</li>
<li>Leave everything else as it is &amp; hit OK</li>
<li>Save the file as <code>RMarkdownTutorial.Rmd</code></li>
</ol>
<p>Before we compile the document, let’s look through a few key features</p>
<section id="the-yaml-header" class="level4">
<h4 class="anchored" data-anchor-id="the-yaml-header">The YAML Header</h4>
<p>A <em>header section</em> is enclosed between the two sets of <code>---</code> lines at the top. <strong>Nothing can be placed before this!</strong>. This header uses YAML (<strong>Y</strong>AML <strong>A</strong>in’t <strong>M</strong>arkup <strong>L</strong>anguage) format, and editing is beyond the scope of this course so let’s leave it as is. However as your skills develop, you’ll be able to set custom <code>.css</code> files, load LaTeX packages, define parameters etc.</p>
</section>
<section id="code-chunks" class="level4">
<h4 class="anchored" data-anchor-id="code-chunks">Code Chunks</h4>
<p>Lines 8 to 10 are a code <code>chunk</code>, which is really just one or more operations that make sense as a block.</p>
<ol type="1">
<li>Chunks always begin with ```{r}</li>
<li>Chunks always end with ``<code>3 Executed</code>R` code goes between these two delineation marks</li>
</ol>
<p>Chunk names are optional and directly follow the letter <code>r</code>, usually using the format ‘chunk-name’. Chunks can also be other languages (<code>bash</code>, <code>python</code> etc.), but R is really the main game. In this first chunk, the <code>r</code> tells RMarkdown the chunk is a chunk of <code>R</code> code</p>
<p>Other key parameters are also set in the chunk header.</p>
<ol type="1">
<li><code>echo = TRUE</code> / <code>include = TRUE</code>: do we show/hide the code and the result</li>
<li><code>results = 'markup'</code>: Show the results using the conventional markup for R output</li>
<li><code>fig.width</code> / <code>fig.height</code>: control the size of any figures</li>
<li><code>fig.cap</code>: The figure caption</li>
</ol>
<p>The master reference is <a href="https://yihui.org/knitr/options/#chunk-options">here</a> and shows there is actually a great deal of control we can apply to each chunk.</p>
<p>If you want to execute the chunks into your interactive session, enter a chunk and use <code>Ctrl+Shift+Enter</code> (Linux/Windows) which is probably <code>Cmd+Shift+Enter</code> on OSX. You can jump to the next chunk using <code>Ctrl+Alt+N</code> (Linux/Windows) or <code>Option+Command+N</code> (OSX)</p>
</section>
<section id="sections-and-sub-sections" class="level4">
<h4 class="anchored" data-anchor-id="sections-and-sub-sections">Sections and Sub-Sections</h4>
<p>Line 12 is a Subsection Heading, starting with <code>##</code>. In order to make sure we can see all the chunks and section headers</p>
<ol type="1">
<li>Click the <em>Outline</em> symbol in the top-right of the Script Window</li>
<li>Chunk names are shown in <em>italics</em> (if set to be shown)
<ul>
<li>If you can’t see the chunk names go to <code>Tools</code> &gt; <code>Global Options</code> &gt; <code>R Markdown</code></li>
<li>Select: Show in document outline - Sections and All Chunks</li>
</ul></li>
<li>Section Names are in plain text</li>
<li>Chunks are indented within Sections</li>
<li>By default Sections start with <code>##</code>
<ul>
<li>Only the Document Title should be Level 1 <code>#</code> although this is only a loose guideline</li>
</ul></li>
</ol>
</section>
<section id="compiling-the-report" class="level4">
<h4 class="anchored" data-anchor-id="compiling-the-report">Compiling The Report</h4>
<p>Now we’ve had a look around, click the <code>Knit</code> (or <code>Render</code>) button at the top of the file, about 1/3 of the way across. This should open up the compiled document as an HTML file, which is the default format.</p>
<p>Look through the compiled document and compare it to the source file.</p>
<ul>
<li>Can you see how the YAML header has rendered in the document?</li>
<li>Can you spot the code chunks</li>
<li>The section headers &amp; the hyperlink?</li>
</ul>
</section>
</section>
<section id="making-our-own-report" class="level3">
<h3 class="anchored" data-anchor-id="making-our-own-report">Making Our Own Report</h3>
<p>Now we’re going to produce our own report, as if we’ve produce the file <code>psen2VsWT.csv</code> ourselves and are presenting our results to share publicly. Leave the entire YAML header, and the very first chunk named <code>setup</code>, but delete all of the content below that.</p>
<p>The first step we should perform in an RMarkdown analysis is to load all the packages we need. We only need the <code>tidyverse</code>, so add a couple of blank lines after the <code>setup</code> chunk, then create a new chunk using the shortcut <code>Alt+Ctrl+I</code> (Windows/Linux) or <code>Cmd+Option+I</code> (OSX). You’ll see an empty R chunk appear with all of the backticks and <code>{r}</code> as is needed.</p>
<p>Edit the chunk header placing a space after the <code>r</code> and add the chunk name <code>load-packages</code>. (No need for a comma, just add the space.)</p>
<p>Inside the chunk enter <code>library(tidyverse)</code>, followed by <code>theme_set(theme_bw())</code> to make sure all of our figures look fire. Compile the document!</p>
<p>Remember all of those “helpful” messages that the <code>tidyverse</code> likes to give to us? They look pretty rubbish here, so after the chunk name, add a comma, then add the argument <code>message = FALSE</code> and recompile. Hopefully now the output file looks much more acceptable</p>
<p>Underneath that chunk, create a new one then give it the chunk name <code>load-data</code> and enter the code</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/psen2VsWT.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>File paths can be a bit more difficult to wrangle when compiling an RMarkdown document, so if RStudio tells you it can’t find the file “psen2VsWT.csv” call a tutor over. The most common causes of this issue are:</p>
<ol type="1">
<li>Not being in a R Project</li>
<li>Not having the file in the directory “data”, with “data” being in the same directory as the RMarkdown document.</li>
</ol>
</div>
</div>
<p>Now add the text describing the file, which might be something like</p>
<blockquote class="blockquote">
<p>Differential Gene Expression analysis was performed on two groups of zebrafish. One group had the wild-type genetic background, whilst for the other group a mutation was induced in the gene <em>psen2</em> In total, 16021 genes were considered to be detected with 2470 genes being considerd to be differentially expressed using an FDR of 0.01</p>
</blockquote>
<p><strong>Don’t forget to put the gene name in italics</strong> using RMarkdown formatting</p>
<p>Now compile and make sure the text looks how you want it to look.</p>
<section id="using-inline-r-code" class="level4">
<h4 class="anchored" data-anchor-id="using-inline-r-code">Using Inline R Code</h4>
<p>One of the brilliant things about RMarkdown is that can pull all results directly from our R objects, meaning we avoid typos (except in our code) when presenting results. In your text as above:</p>
<ol type="1">
<li>Change the number <code>16021</code> to be the exact text `<code>r</code> <code>nrow(psen2VsWT)</code>`</li>
<li>Change 2470 to be `<code>r</code> <code>sum(psen2VsWT$FDR &lt; 0.01)</code>`</li>
</ol>
<p>Now recompile the document.</p>
<p>If everything worked as it should, you’ll have these numbers printed in your compiled document, but <em>they have been taken directly from your results</em></p>
<div class="callout callout-style-default callout-important callout-titled" title="Reproducible Code">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Reproducible Code
</div>
</div>
<div class="callout-body-container callout-body">
<p>Every time we compile the document, a new R session is created by RStudio, which is completely separate to the interactive session we can access using the R Console. Even if you have the data object in your interactive session, during compilation, the data will be reloaded and all code chunks run in a completely new, isolated R session that is closed down once the compilation has completed.</p>
<p>This ensures that all code can be run as a complete, self-contained analysis, making the entire process reproducible</p>
</div>
</div>
</section>
<section id="creating-tables" class="level4">
<h4 class="anchored" data-anchor-id="creating-tables">Creating Tables</h4>
<p>Let’s summarise our DE genes by gene_biotype using the tricks from the <code>tidyverse</code> in the previous practical. Try executing this chunk interactively first and make sure you understand each line. There’s a new function in there called <code>relocate()</code> which moves a column to different position.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DE =</span> FDR <span class="sc">&lt;</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gene_biotype, DE) <span class="sc">%&gt;%</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> DE, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">NotDE =</span> <span class="st">`</span><span class="at">FALSE</span><span class="st">`</span>, <span class="at">DE =</span> <span class="st">`</span><span class="at">TRUE</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Detected =</span> NotDE <span class="sc">+</span> DE,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pDE =</span> DE <span class="sc">/</span> Detected</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(Detected, <span class="at">.after =</span> gene_biotype) <span class="sc">%&gt;%</span> </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Detected))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now compile the document and this table should appear with a series of hashes in front of each line. Doesn’t really look great to be honest.</p>
<p>Fortunately, there are bunch of packages which can take this type of table an produce a beautiful RMarkdown table, with <code>pander</code> being a great all-rounder.</p>
<p>In your <code>load-packages</code> chunk, add <code>library(pander)</code> after <code>library(tidyverse)</code> and execute that interactively so the package <code>pander</code> is in your interactive session. Now pipe that last <code>arrange(desc(Detected))</code> into the function <code>pander()</code> and you’ll see a table appear in markdown format.</p>
<p>We can now add a table caption by placing some text inside the function <code>pander()</code> such as <code>pander(caption = "Summary of detected and DE genes by gene biotype, with the proportion of DE genes from each biotype shown in the final column")</code></p>
<p><strong>Recompile after piping the table into <code>pander()</code></strong></p>
<p>The table should now look beautifully formatted in the HTML document</p>
</section>
<section id="adding-figures" class="level4">
<h4 class="anchored" data-anchor-id="adding-figures">Adding Figures</h4>
<p>Let’s make a volcano plot, which shows logFC against a measure of significance, like the <span class="math inline">\(p\)</span>-value, usually transformed using log<sub>10</sub>. Begin a new chunk called <code>volcano-plot</code> and add the following, and execute interactively.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice that we’ve shifted the initial call to <code>aes()</code> inside the initial call to <code>ggplot</code>. This is a very common way to being the plot with the previous approach and this one both being totally acceptable.</p>
<p>Importantly, any mapping in that initial call to <code>aes()</code> is passed down to every additional layer</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">DE =</span> FDR <span class="sc">&lt;</span> <span class="fl">0.01</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">log10p =</span> <span class="fu">log10</span>(PValue)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(logFC, <span class="sc">-</span>log10p, <span class="at">colour =</span> DE)) <span class="sc">+</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a nice looking plot, but let’s add some gene names to really tell a story. We’ll use the function <code>geom_text_repel()</code> from the package <code>ggrepel</code>, which adds text labels, that repel fro each other so they overlap as little as possible.</p>
<p>Go back to your <code>load-packages</code> chunk and add <code>library(ggrepel)</code> then execute so it’s in your interactive session. Now modify the above chunk to be</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>psen2VsWT <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">DE =</span> FDR <span class="sc">&lt;</span> <span class="fl">0.01</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">log10p =</span> <span class="fu">log10</span>(PValue)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(logFC, <span class="sc">-</span>log10p, <span class="at">colour =</span> DE)) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> gene_name),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The call to <code>geom_text_repel()</code> uses a very neat trick, that is specific to the <code>magrittr</code>, and that doesn’t work with the base pipe. We’ve modified the data object, passed down as <code>.</code>, by calling <code>slice(1:10)</code> which will just return the first two rows inside the function <code>geom_text_repel()</code> only. This is a great way of adding the top 10 gene names, instead of all 16,000, which would look terrible and would also take minutes to plot.</p>
</div>
</div>
<p>In the chunk header for this figure, add <code>fig.cap = "Volcano plot with the top10 genes labelled"</code> and recompile.</p>
<p><strong>Now add the MA plot below that, also labelling the top 10 genes by fold-change instead of PValue</strong></p>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We’ll be using RMarkdown for all remaining transcriptomics practicals, so you’ll be able to familiarise yourself with it over the coming weeks. Today will have made an excellent primer for you.</p>
</section>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Wickham2016-gg" class="csl-entry" role="listitem">
Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>